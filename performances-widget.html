<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Performances — Tyler Kline</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --black: #1a1a1a;
    --grey-dark: #555;
    --grey-mid: #888;
    --grey-light: #bbb;
    --grey-rule: #e2e2e2;
    --accent: #6B8A9A;
    --accent-light: #f0f5f7;
    --white: #ffffff;
    --font: 'Roboto', sans-serif;
  }

  /* Force white background regardless of browser dark mode */
  html, body {
    color-scheme: light only;
    background: var(--white) !important;
    color: var(--black) !important;
  }

  body {
    font-family: var(--font);
    font-size: 13px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    background: var(--white);
    color: var(--black);
  }

  .widget {
    max-width: 820px;
    margin: 0 auto;
    padding: 36px 20px 48px;
    background: var(--white);
    color: var(--black);
  }

  /* ── Loading / Error ── */
  .status-msg {
    text-align: center;
    padding: 40px 20px;
    color: var(--grey-mid);
    font-size: 13px;
    font-weight: 300;
    letter-spacing: 0.04em;
  }

  /* ── Header ── */
  .widget-header {
    text-align: center;
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--black);
  }

  .widget-header h1 {
    font-family: var(--font);
    font-weight: 300;
    font-size: 1.4rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .widget-header p {
    font-size: 0.72rem;
    color: var(--grey-mid);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-weight: 300;
  }

  .premiere-key {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-top: 8px;
    font-size: 0.68rem;
    color: var(--grey-mid);
    letter-spacing: 0.07em;
    font-weight: 300;
  }

  .premiere-dot {
    display: inline-block;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--accent);
    flex-shrink: 0;
  }

  /* ── Layout ── */
  .layout {
    display: flex;
    gap: 0;
    align-items: flex-start;
  }

  /* ── Year Nav ── */
  .year-nav {
    width: 72px;
    flex-shrink: 0;
    position: sticky;
    top: 16px;
  }

  .year-nav button {
    display: block;
    width: 100%;
    background: none;
    border: none;
    cursor: pointer;
    text-align: right;
    padding: 4px 14px 4px 0;
    font-family: var(--font);
    font-size: 0.72rem;
    font-weight: 300;
    letter-spacing: 0.06em;
    color: var(--grey-light);
    transition: color 0.15s;
    position: relative;
    line-height: 1.8;
  }

  .year-nav button::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 12px;
    background: var(--grey-rule);
    transition: background 0.2s, height 0.2s;
  }

  .year-nav button:hover { color: var(--grey-dark); }

  .year-nav button.active {
    color: var(--black);
    font-weight: 500;
  }

  .year-nav button.active::after {
    background: var(--accent);
    height: 18px;
  }

  .year-nav .upcoming-btn {
    font-style: italic;
    color: var(--accent);
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--grey-rule);
  }

  .year-nav .upcoming-btn:not(.active) {
    color: #a0bec9;
  }

  .year-nav .upcoming-btn::after {
    background: var(--accent);
  }

  /* ── Performances Panel ── */
  .performances {
    flex: 1;
    padding-left: 24px;
    border-left: 1px solid var(--grey-rule);
  }

  /* Scrollable container */
  .scroll-container {
    max-height: 520px;
    overflow-y: auto;
    padding-right: 6px;
  }

  .scroll-container::-webkit-scrollbar {
    width: 3px;
  }
  .scroll-container::-webkit-scrollbar-track {
    background: transparent;
  }
  .scroll-container::-webkit-scrollbar-thumb {
    background: var(--grey-rule);
    border-radius: 2px;
  }

  .year-section { display: none; }
  .year-section.visible { display: block; }

  /* ── UPCOMING: Card mode ── */
  .upcoming-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .perf-card {
    background: var(--accent-light);
    border-left: 2px solid var(--accent);
    padding: 10px 14px;
    border-radius: 0 2px 2px 0;
  }

  .card-date {
    font-size: 0.68rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 3px;
  }

  .card-title {
    font-size: 0.9rem;
    font-weight: 400;
    font-style: italic;
    color: var(--black);
    margin-bottom: 2px;
    line-height: 1.3;
  }

  .card-title .prem {
    font-style: normal;
    font-size: 0.62rem;
    font-weight: 400;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--accent);
    margin-left: 6px;
    vertical-align: middle;
  }

  .card-performers {
    font-size: 0.75rem;
    font-weight: 300;
    color: var(--grey-dark);
    margin-bottom: 1px;
  }

  .card-venue {
    font-size: 0.72rem;
    font-weight: 300;
    color: var(--grey-mid);
    line-height: 1.4;
  }

  .card-location {
    font-size: 0.68rem;
    font-weight: 300;
    color: var(--grey-light);
    margin-top: 2px;
    letter-spacing: 0.03em;
  }

  /* ── PAST YEARS: List mode ── */
  .perf-row {
    padding: 8px 0;
    border-bottom: 1px solid var(--grey-rule);
  }

  .perf-row:last-of-type {
    border-bottom: none;
  }

  .perf-row-line {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    font-size: 0.76rem;
    line-height: 1.6;
    gap: 0;
  }

  .perf-row-line .sep {
    color: var(--grey-rule);
    margin: 0 6px;
    font-size: 0.55rem;
    flex-shrink: 0;
    line-height: inherit;
  }

  .pr-date {
    font-weight: 500;
    color: var(--black);
    white-space: nowrap;
    font-size: 0.73rem;
  }

  .pr-piece {
    font-weight: 500;
    font-style: italic;
    color: var(--black);
  }

  .pr-prem {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-style: normal;
    font-size: 0.58rem;
    font-weight: 400;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: var(--accent);
    margin-left: 5px;
    vertical-align: middle;
  }

  .pr-performer {
    font-weight: 300;
    color: var(--grey-dark);
  }

  .pr-venue {
    font-weight: 300;
    color: var(--grey-dark);
  }

  .pr-location {
    font-weight: 300;
    color: var(--grey-light);
    font-size: 0.7rem;
  }

  /* ── Count note ── */
  .count-note {
    font-size: 0.68rem;
    color: var(--grey-light);
    font-weight: 300;
    letter-spacing: 0.04em;
    margin-top: 14px;
    font-style: italic;
  }

  /* ── Responsive ── */
  @media (max-width: 580px) {
    .year-nav { width: 56px; }
    .year-nav button { font-size: 0.65rem; padding-right: 10px; }
    .performances { padding-left: 14px; }
    .pr-venue, .pr-location { display: none; }
    .perf-row-line .sep:nth-child(7),
    .perf-row-line .sep:nth-child(9) { display: none; }
  }
</style>
</head>
<body>
<div class="widget">

  <div class="widget-header">
    <h1>Performances</h1>
    <p>2010 – present &nbsp;·&nbsp; including upcoming</p>
    <div class="premiere-key">
      <span class="premiere-dot"></span>
      world premiere
    </div>
  </div>

  <div class="layout">

    <nav class="year-nav" id="yearNav"></nav>

    <div class="performances">
      <div class="scroll-container" id="perfList">
        <div class="status-msg" id="statusMsg">Loading performances…</div>
      </div>
    </div>

  </div>
</div>

<script>
// ─────────────────────────────────────────────
// CONFIG — only thing to change if sheet moves
// ─────────────────────────────────────────────
const SHEET_ID = '1lX5NAn76JfdchYjejh6yAIC-jcZgy-tfy84IOs4vjDQ';
const SHEET_NAME = 'Sheet1';

// ─────────────────────────────────────────────
// FETCH & PARSE
// ─────────────────────────────────────────────
async function loadData() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\)/)[1]);
  const rows = json.table.rows;
  const cols = json.table.cols.map(c => c.label.trim());

  return rows.map(row => {
    const get = (label) => {
      const i = cols.indexOf(label);
      if (i === -1) return '';
      const cell = row.c[i];
      return cell && cell.v !== null ? String(cell.v).trim() : '';
    };

    let rawDate = get('Date');
    let dateObj = null;
    const dm = rawDate.match(/Date\((\d+),(\d+),(\d+)\)/);
    if (dm) {
      dateObj = new Date(parseInt(dm[1]), parseInt(dm[2]), parseInt(dm[3]));
    } else if (rawDate) {
      dateObj = new Date(rawDate);
    }

    const isPremiere = get('Composition').endsWith('*');
    const composition = get('Composition').replace(/\*$/, '').trim();

    return {
      dateObj,
      dateStr: dateObj ? formatDate(dateObj) : rawDate,
      year: dateObj ? dateObj.getFullYear() : null,
      composition,
      isPremiere,
      performers: get('Performer(s)/Ensembles'),
      venue: get('Venue/Event'),
      city: get('City'),
      state: get('State'),
      country: get('Country'),
    };
  }).filter(r => r.year && r.year > 1950 && r.composition);
}

function formatDate(d) {
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
}

function locationStr(r) {
  const parts = [r.city];
  if (r.state && r.state !== '- - -') parts.push(r.state);
  if (r.country) parts.push(r.country);
  return parts.filter(Boolean).join(', ');
}

// ─────────────────────────────────────────────
// RENDER
// ─────────────────────────────────────────────
function render(performances) {
  const now = new Date();
  now.setHours(0,0,0,0);

  const upcoming = performances
    .filter(p => p.dateObj >= now)
    .sort((a,b) => a.dateObj - b.dateObj);

  const past = performances
    .filter(p => p.dateObj < now)
    .sort((a,b) => b.dateObj - a.dateObj);

  const years = [...new Set(past.map(p => p.year))].sort((a,b) => b - a);

  // Build year nav
  const nav = document.getElementById('yearNav');
  nav.innerHTML = '';

  const upBtn = document.createElement('button');
  upBtn.className = 'upcoming-btn active';
  upBtn.dataset.year = 'upcoming';
  upBtn.textContent = 'upcoming';
  upBtn.onclick = () => showYear('upcoming');
  nav.appendChild(upBtn);

  years.forEach(y => {
    const btn = document.createElement('button');
    btn.dataset.year = y;
    btn.textContent = y;
    btn.onclick = () => showYear(String(y));
    nav.appendChild(btn);
  });

  // Build content
  const list = document.getElementById('perfList');
  list.innerHTML = '';

  // Upcoming section
  const upSection = buildUpcomingSection(upcoming);
  upSection.id = 'section-upcoming';
  upSection.className = 'year-section visible';
  list.appendChild(upSection);

  // Past year sections
  years.forEach(y => {
    const yearPerfs = past.filter(p => p.year === y);
    const section = buildListSection(y, yearPerfs);
    section.id = `section-${y}`;
    section.className = 'year-section';
    list.appendChild(section);
  });
}

function buildUpcomingSection(perfs) {
  const div = document.createElement('div');
  if (perfs.length === 0) {
    div.innerHTML = '<p class="count-note" style="padding:12px 0">No upcoming performances scheduled.</p>';
    return div;
  }
  const grid = document.createElement('div');
  grid.className = 'upcoming-grid';
  perfs.forEach(p => {
    const card = document.createElement('div');
    card.className = 'perf-card';
    card.innerHTML = `
      <div class="card-date">${p.dateStr}</div>
      <div class="card-title">${esc(p.composition)}${p.isPremiere ? '<span class="prem">· world premiere</span>' : ''}</div>
      <div class="card-performers">${esc(p.performers)}</div>
      <div class="card-venue">${esc(p.venue)}</div>
      <div class="card-location">${esc(locationStr(p))}</div>
    `;
    grid.appendChild(card);
  });
  div.appendChild(grid);
  div.innerHTML += `<p class="count-note">${perfs.length} upcoming performance${perfs.length !== 1 ? 's' : ''}</p>`;
  return div;
}

function buildListSection(year, perfs) {
  const div = document.createElement('div');
  perfs.forEach(p => {
    const row = document.createElement('div');
    row.className = 'perf-row';
    const premiereTag = p.isPremiere
      ? `<span class="pr-prem"><span style="display:inline-block;width:5px;height:5px;border-radius:50%;background:#6B8A9A;margin-right:3px;vertical-align:middle"></span>world premiere</span>`
      : '';
    const loc = locationStr(p);
    row.innerHTML = `
      <div class="perf-row-line">
        <span class="pr-date">${esc(p.dateStr)}</span>
        <span class="sep">●</span>
        <span class="pr-piece">${esc(p.composition)}${premiereTag}</span>
        <span class="sep">●</span>
        <span class="pr-performer">${esc(p.performers)}</span>
        <span class="sep">●</span>
        <span class="pr-venue">${esc(p.venue)}</span>
        ${loc ? `<span class="sep">●</span><span class="pr-location">${esc(loc)}</span>` : ''}
      </div>
    `;
    div.appendChild(row);
  });
  div.innerHTML += `<p class="count-note">${perfs.length} performance${perfs.length !== 1 ? 's' : ''} in ${year}</p>`;
  return div;
}

function showYear(year) {
  document.querySelectorAll('.year-section').forEach(s => s.classList.remove('visible'));
  document.querySelectorAll('.year-nav button').forEach(b => b.classList.remove('active'));
  const section = document.getElementById('section-' + year);
  if (section) section.classList.add('visible');
  const btn = document.querySelector(`[data-year="${year}"]`);
  if (btn) btn.classList.add('active');
  // Scroll to top of list on year change
  document.getElementById('perfList').scrollTop = 0;
}

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─────────────────────────────────────────────
// INIT
// ─────────────────────────────────────────────
loadData()
  .then(data => {
    document.getElementById('statusMsg')?.remove();
    render(data);
  })
  .catch(err => {
    document.getElementById('statusMsg').textContent = 'Could not load performances. Please try again later.';
    console.error(err);
  });
</script>
</body>
</html>
