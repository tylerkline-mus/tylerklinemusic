<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Performance Map — Tyler Kline</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,200;0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --black: #1a1a1a;
    --grey-dark: #444;
    --grey-mid: #777;
    --grey-light: #999;
    --grey-rule: #dedede;
    --accent: #6B8A9A;
    --accent-light: #f0f5f7;
    --white: #ffffff;
    --font: 'Jost', sans-serif;
    --nav-width: 148px;
  }

  html, body {
    color-scheme: light only;
    background: var(--white) !important;
    color: var(--black) !important;
  }

  body {
    font-family: var(--font);
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    background: var(--white);
    color: var(--black);
  }

  .widget {
    max-width: 900px;
    margin: 0 auto;
    padding: 36px 20px 48px;
    background: var(--white);
    color: var(--black);
  }

  /* ── Header ── */
  .widget-header {
    text-align: center;
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--black);
  }

  .widget-header h1 {
    font-weight: 200;
    font-size: 1.6rem;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    margin-bottom: 5px;
  }

  .widget-header p {
    font-size: 0.74rem;
    color: var(--grey-mid);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 300;
  }

  .premiere-key {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-top: 8px;
    font-size: 0.7rem;
    color: var(--grey-mid);
    letter-spacing: 0.07em;
    font-weight: 300;
  }

  .premiere-dot {
    display: inline-block;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--accent);
    flex-shrink: 0;
  }

  /* ── Layout ── */
  .layout {
    display: flex;
    gap: 0;
    align-items: flex-start;
  }

  /* ── Year Nav ── */
  .year-nav {
    width: var(--nav-width);
    flex-shrink: 0;
    position: sticky;
    top: 16px;
    padding-right: 4px;
  }

  .year-nav button {
    display: block;
    width: 100%;
    background: none;
    border: none;
    cursor: pointer;
    text-align: right;
    padding: 4px 14px 4px 0;
    font-family: var(--font);
    font-size: 0.75rem;
    font-weight: 300;
    letter-spacing: 0.05em;
    color: var(--grey-mid);
    transition: color 0.15s;
    position: relative;
    line-height: 1.9;
    white-space: nowrap;
  }

  .year-nav button::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 12px;
    background: var(--grey-rule);
    transition: background 0.2s, height 0.2s;
  }

  .year-nav button:hover { color: var(--black); }

  .year-nav button.active {
    color: var(--black);
    font-weight: 500;
  }

  .year-nav button.active::after {
    background: var(--accent);
    height: 20px;
  }

  .year-nav .upcoming-btn {
    font-style: italic;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .year-nav .upcoming-btn:not(.active) { color: #90b4c2; }
  .year-nav .upcoming-btn::after { background: var(--accent); }

  .year-nav .full-history-btn {
    font-size: 0.68rem;
    letter-spacing: 0.04em;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--grey-rule);
    color: var(--grey-mid);
    white-space: normal;
    text-align: right;
    line-height: 1.5;
    padding-right: 14px;
  }

  .year-nav .full-history-btn.active { color: var(--black); font-weight: 500; }

  /* ── Map container ── */
  .map-wrap {
    flex: 1;
    border-left: 1px solid var(--grey-rule);
    padding-left: 0;
    position: relative;
  }

  .map-count {
    font-size: 0.72rem;
    color: var(--grey-light);
    font-weight: 300;
    letter-spacing: 0.04em;
    font-style: italic;
    padding: 0 0 10px 16px;
  }

  #map {
    width: 100%;
    height: 650px;
  }

  /* ── Loading overlay ── */
  .map-loading {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    z-index: 1000;
    font-size: 0.78rem;
    color: var(--grey-mid);
    font-weight: 300;
    letter-spacing: 0.06em;
  }

  .loading-bar-wrap {
    width: 160px;
    height: 2px;
    background: var(--grey-rule);
    border-radius: 2px;
    overflow: hidden;
  }

  .loading-bar {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 2px;
  }

  /* ── Leaflet popup ── */
  .leaflet-popup-content-wrapper {
    border-radius: 2px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    font-family: var(--font);
    padding: 0;
    border: none;
  }

  .leaflet-popup-content { margin: 0; }

  .popup-inner {
    padding: 12px 16px;
    min-width: 200px;
    max-width: 260px;
  }

  .popup-venue {
    font-size: 0.84rem;
    font-weight: 500;
    color: var(--black);
    margin-bottom: 2px;
    line-height: 1.3;
  }

  .popup-location {
    font-size: 0.72rem;
    font-weight: 300;
    color: var(--grey-mid);
    margin-bottom: 8px;
  }

  .popup-perf {
    font-size: 0.72rem;
    font-weight: 300;
    color: var(--grey-dark);
    padding: 5px 0;
    border-top: 1px solid #f0f0f0;
    line-height: 1.5;
  }

  .popup-perf + .popup-perf {
    border-top: 1px solid #f0f0f0;
  }

  .popup-piece {
    font-style: italic;
    font-weight: 400;
    color: var(--black);
  }

  .popup-more {
    font-size: 0.68rem;
    color: var(--grey-light);
    font-style: italic;
    padding-top: 4px;
    border-top: 1px solid #f0f0f0;
    margin-top: 2px;
  }

  /* ── Responsive ── */
  @media (max-width: 600px) {
    :root { --nav-width: 110px; }
    .year-nav button { font-size: 0.68rem; }
    .year-nav .full-history-btn { font-size: 0.62rem; }
  }
</style>
</head>
<body>
<div class="widget">

  <div class="widget-header">
    <h1>Performance Map</h1>
    <p>2010 – present &nbsp;·&nbsp; including upcoming</p>
    <div class="premiere-key">
      <span class="premiere-dot"></span>
      world premiere
    </div>
  </div>

  <div class="layout">
    <nav class="year-nav" id="yearNav"></nav>
    <div class="map-wrap" id="mapWrap">
      <div class="map-count" id="mapCount">&nbsp;</div>
      <div id="map"></div>
      <div class="map-loading" id="mapLoading">
        <div>Locating venues…</div>
        <div class="loading-bar-wrap"><div class="loading-bar" id="loadingBar"></div></div>
        <div id="loadingDetail" style="font-size:0.68rem;color:#bbb"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ─────────────────────────────────────────────
// CONFIG
// ─────────────────────────────────────────────
const SHEET_ID = '1lX5NAn76JfdchYjejh6yAIC-jcZgy-tfy84IOs4vjDQ';
const SHEET_NAME = 'Sheet1';
const ACCENT = '#6B8A9A';
const NOMINATIM_DELAY = 1100; // ms between requests (rate limit)

// ─────────────────────────────────────────────
// MAP INIT
// ─────────────────────────────────────────────
const map = L.map('map', {
  center: [20, 10],
  zoom: 2,
  zoomControl: true,
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19,
}).addTo(map);

// ─────────────────────────────────────────────
// PIN
// ─────────────────────────────────────────────
function pinSizeForZoom(zoom) {
  if (zoom <= 2)  return 11;
  if (zoom <= 4)  return 13;
  if (zoom <= 6)  return 15;
  if (zoom <= 8)  return 17;
  if (zoom <= 10) return 19;
  return 21;
}

function makePinIcon(zoom) {
  const size = pinSizeForZoom(zoom);
  const h = Math.round(size * 1.5);
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${h}" viewBox="0 0 20 30">
    <path d="M10 1C5.58 1 2 4.58 2 9c0 6.25 8 20 8 20S18 15.25 18 9C18 4.58 14.42 1 10 1z"
      fill="${ACCENT}" stroke="#ffffff" stroke-width="2"/>
    <circle cx="10" cy="9" r="3.2" fill="#ffffff"/>
  </svg>`;
  return L.divIcon({
    className: '',
    html: svg,
    iconSize: [size, h],
    iconAnchor: [size / 2, h],
    popupAnchor: [0, -(h + 2)],
  });
}

// ─────────────────────────────────────────────
// FETCH SHEET DATA
// ─────────────────────────────────────────────
async function loadSheet() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\)/)[1]);
  const rows = json.table.rows;
  const cols = json.table.cols.map(c => c.label.trim());

  return rows.map(row => {
    const get = (label) => {
      const i = cols.indexOf(label);
      if (i === -1) return '';
      const cell = row.c[i];
      return cell && cell.v !== null ? String(cell.v).trim() : '';
    };

    let rawDate = get('Date');
    let dateObj = null;
    const dm = rawDate.match(/Date\((\d+),(\d+),(\d+)\)/);
    if (dm) {
      dateObj = new Date(parseInt(dm[1]), parseInt(dm[2]), parseInt(dm[3]));
    } else if (rawDate) {
      dateObj = new Date(rawDate);
    }

    const isPremiere = get('Composition').endsWith('*');
    const composition = get('Composition').replace(/\*$/, '').trim();

    return {
      dateObj,
      dateStr: dateObj ? formatDate(dateObj) : rawDate,
      year: dateObj ? dateObj.getFullYear() : null,
      composition,
      isPremiere,
      performers: get('Performer(s)/Ensembles'),
      venue: get('Venue/Event'),
      city: get('City'),
      state: get('State'),
      country: get('Country'),
      venueKey: venueKey(get('Venue/Event'), get('City'), get('Country')),
    };
  }).filter(r => r.year && r.year > 1950 && r.composition);
}

function formatDate(d) {
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
}

function venueKey(venue, city, country) {
  return `${venue}|${city}|${country}`.toLowerCase().replace(/\s+/g, ' ').trim();
}

// ─────────────────────────────────────────────
// GEOCODING (Nominatim + localStorage cache)
// ─────────────────────────────────────────────
const GEO_CACHE_KEY = 'tk_geo_cache_v1';

function loadGeoCache() {
  try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || '{}'); }
  catch { return {}; }
}

function saveGeoCache(cache) {
  try { localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache)); }
  catch {}
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function geocodeVenues(performances) {
  const cache = loadGeoCache();
  const uniqueVenues = [...new Map(performances.map(p => [p.venueKey, p])).values()];
  const toFetch = uniqueVenues.filter(p => !cache[p.venueKey]);
  
  const loadingEl = document.getElementById('mapLoading');
  const barEl = document.getElementById('loadingBar');
  const detailEl = document.getElementById('loadingDetail');

  if (toFetch.length > 0) {
    loadingEl.style.display = 'flex';

    for (let i = 0; i < toFetch.length; i++) {
      const p = toFetch[i];
      const pct = Math.round((i / toFetch.length) * 100);
      barEl.style.width = pct + '%';
      detailEl.textContent = `${p.city}${p.country ? ', ' + p.country : ''}`;

      // Build search query — venue + city + country
      const query = [p.venue.split('\n')[0].trim(), p.city, p.state, p.country]
        .filter(Boolean).join(', ');

      try {
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
        const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
        const data = await res.json();
        if (data && data[0]) {
          cache[p.venueKey] = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        } else {
          // Fallback: city only
          const fallback = `${p.city}, ${p.country}`;
          const res2 = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(fallback)}&format=json&limit=1`, { headers: { 'Accept-Language': 'en' } });
          const data2 = await res2.json();
          if (data2 && data2[0]) {
            cache[p.venueKey] = { lat: parseFloat(data2[0].lat), lng: parseFloat(data2[0].lon) };
          }
        }
      } catch (e) {
        console.warn('Geocoding failed for', query, e);
      }

      saveGeoCache(cache);
      if (i < toFetch.length - 1) await sleep(NOMINATIM_DELAY);
    }

    barEl.style.width = '100%';
    await sleep(300);
  }

  loadingEl.style.display = 'none';
  return cache;
}

// ─────────────────────────────────────────────
// MARKERS
// ─────────────────────────────────────────────
let currentMarkers = [];

function clearMarkers() {
  currentMarkers.forEach(m => map.removeLayer(m));
  currentMarkers = [];
}

function buildMarkers(performances, geoCache) {
  clearMarkers();

  // Group by venue
  const venueMap = new Map();
  performances.forEach(p => {
    if (!geoCache[p.venueKey]) return;
    if (!venueMap.has(p.venueKey)) {
      venueMap.set(p.venueKey, { coords: geoCache[p.venueKey], perfs: [], venue: p.venue.split('\n')[0].trim(), city: p.city, state: p.state, country: p.country });
    }
    venueMap.get(p.venueKey).perfs.push(p);
  });

  const icon = makePinIcon(map.getZoom());

  venueMap.forEach(({ coords, perfs, venue, city, state, country }) => {
    const loc = [city, state !== '- - -' ? state : null, country].filter(Boolean).join(', ');

    // Build popup — show up to 4 performances, then "and X more"
    const shown = perfs.slice(0, 4);
    const extra = perfs.length - shown.length;

    const perfsHtml = shown.map(p => `
      <div class="popup-perf">
        <span class="popup-piece">${esc(p.composition)}</span>${p.isPremiere ? ' <span style="font-size:0.6rem;letter-spacing:0.07em;text-transform:uppercase;color:' + ACCENT + '">★ premiere</span>' : ''}<br>
        ${esc(p.performers)}<br>
        <span style="color:#aaa;font-size:0.68rem">${p.dateStr}</span>
      </div>`).join('');

    const extraHtml = extra > 0
      ? `<div class="popup-more">+ ${extra} more performance${extra !== 1 ? 's' : ''} at this venue</div>`
      : '';

    const popup = `<div class="popup-inner">
      <div class="popup-venue">${esc(venue)}</div>
      <div class="popup-location">${esc(loc)}</div>
      ${perfsHtml}
      ${extraHtml}
    </div>`;

    const marker = L.marker([coords.lat, coords.lng], { icon })
      .bindPopup(popup, { maxWidth: 280 })
      .addTo(map);

    currentMarkers.push(marker);
  });

  // Rebuild on zoom to resize pins
  map.off('zoomend');
  map.on('zoomend', () => {
    const newIcon = makePinIcon(map.getZoom());
    currentMarkers.forEach(m => m.setIcon(newIcon));
  });
}

function fitToMarkers(performances, geoCache, forceWorld = false) {
  if (forceWorld) {
    map.setView([20, 10], 2);
    return;
  }

  const coords = performances
    .filter(p => geoCache[p.venueKey])
    .map(p => geoCache[p.venueKey]);

  if (coords.length === 0) return;

  if (coords.length === 1) {
    map.setView([coords[0].lat, coords[0].lng], 10);
    return;
  }

  const bounds = L.latLngBounds(coords.map(c => [c.lat, c.lng]));
  map.fitBounds(bounds, { padding: [48, 48], maxZoom: 10 });
}

// ─────────────────────────────────────────────
// RENDER
// ─────────────────────────────────────────────
let allPerformances = [];
let geoCache = {};

function showTab(tabId, performances, forceWorld = false) {
  // Update nav
  document.querySelectorAll('.year-nav button').forEach(b => b.classList.remove('active'));
  const btn = document.querySelector(`[data-tab="${tabId}"]`);
  if (btn) btn.classList.add('active');

  // Update count
  const countEl = document.getElementById('mapCount');
  const venueCount = new Set(performances.filter(p => geoCache[p.venueKey]).map(p => p.venueKey)).size;
  countEl.textContent = `${performances.length} performance${performances.length !== 1 ? 's' : ''} · ${venueCount} venue${venueCount !== 1 ? 's' : ''}`;

  buildMarkers(performances, geoCache);
  fitToMarkers(performances, geoCache, forceWorld);
}

function render(performances) {
  const now = new Date();
  now.setHours(0,0,0,0);

  const upcoming = performances.filter(p => p.dateObj >= now).sort((a,b) => b.dateObj - a.dateObj);
  const past = performances.filter(p => p.dateObj < now).sort((a,b) => b.dateObj - a.dateObj);
  const years = [...new Set(past.map(p => p.year))].sort((a,b) => b - a);

  const nav = document.getElementById('yearNav');
  nav.innerHTML = '';

  // Upcoming button
  const upBtn = document.createElement('button');
  upBtn.className = 'upcoming-btn active';
  upBtn.dataset.tab = 'upcoming';
  upBtn.textContent = 'upcoming';
  upBtn.onclick = () => showTab('upcoming', upcoming);
  nav.appendChild(upBtn);

  // Full Performance History button
  const allBtn = document.createElement('button');
  allBtn.className = 'full-history-btn';
  allBtn.dataset.tab = 'all';
  allBtn.textContent = 'Full Performance History';
  allBtn.onclick = () => showTab('all', performances, true);
  nav.appendChild(allBtn);

  // Year buttons
  years.forEach(y => {
    const btn = document.createElement('button');
    btn.dataset.tab = String(y);
    btn.textContent = y;
    btn.onclick = () => {
      const yearPerfs = past.filter(p => p.year === y);
      showTab(String(y), yearPerfs);
    };
    nav.appendChild(btn);
  });

  // Default: show upcoming
  showTab('upcoming', upcoming);
}

// ─────────────────────────────────────────────
// INIT
// ─────────────────────────────────────────────
async function init() {
  try {
    allPerformances = await loadSheet();
    geoCache = await geocodeVenues(allPerformances);
    render(allPerformances);
  } catch (err) {
    document.getElementById('mapLoading').innerHTML =
      '<div style="color:#888;font-size:0.78rem">Could not load performance data.</div>';
    console.error(err);
  }
}

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

init();
</script>
</body>
</html>
