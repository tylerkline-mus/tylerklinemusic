<!DOCTYPE html>
<html lang="en" style="color-scheme: light;">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sheet Music — Tyler Kline</title>
<link href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,200;0,300;0,400;0,500;1,200;1,300;1,400;1,500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    color-scheme: light;
    background: #fff !important;
    color: #1A1A1A !important;
    font-family: 'Jost', sans-serif;
    font-weight: 300;
    -webkit-font-smoothing: antialiased;
  }

  body {
    padding: 40px 20px 80px;
    max-width: 900px;
    margin: 0 auto;
  }

  /* ── LOADING / ERROR ── */
  #loading {
    text-align: center;
    padding: 80px 20px;
    color: #999;
    font-size: 0.75rem;
    font-weight: 400;
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  #error-msg {
    text-align: center;
    padding: 80px 20px;
    color: #c0392b;
    font-size: 0.8rem;
    font-weight: 300;
  }

  /* ════════════════════════════════
     CATALOG VIEW
  ════════════════════════════════ */

  /* Store header */
  .store-header {
    border-bottom: 1px solid #DEDEDE;
    padding-bottom: 28px;
    margin-bottom: 28px;
  }

  .store-title {
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 200;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    line-height: 1.1;
    color: #1A1A1A;
    margin-bottom: 14px;
  }

  .store-description {
    font-size: 0.82rem;
    font-weight: 300;
    color: #777;
    line-height: 1.7;
    max-width: 560px;
  }

  .store-description a {
    color: #6B8A9A;
    text-decoration: none;
    border-bottom: 1px solid #6B8A9A;
    padding-bottom: 1px;
    transition: color 0.15s, border-color 0.15s;
  }

  .store-description a:hover { color: #1A1A1A; border-color: #1A1A1A; }

  /* Toolbar */
  .toolbar {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 32px;
    flex-wrap: wrap;
  }

  .filters-wrap {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: flex-start;
  }

  .filter-group {
    position: relative;
  }

  .filter-group-label {
    font-size: 0.6rem;
    font-weight: 500;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    color: #aaa;
    margin-bottom: 5px;
  }

  /* Dropdown trigger button */
  .filter-trigger {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #fff;
    border: 1px solid #DEDEDE;
    border-radius: 2px;
    padding: 7px 12px;
    font-family: 'Jost', sans-serif;
    font-size: 0.72rem;
    font-weight: 300;
    letter-spacing: 0.06em;
    color: #444;
    cursor: pointer;
    transition: border-color 0.15s;
    white-space: nowrap;
    min-width: 150px;
    justify-content: space-between;
  }

  .filter-trigger:hover,
  .filter-trigger.active { border-color: #6B8A9A; }

  .filter-trigger.has-selection {
    border-color: #6B8A9A;
    color: #6B8A9A;
  }

  .filter-trigger svg {
    width: 8px; height: 8px;
    fill: currentColor;
    flex-shrink: 0;
    transition: transform 0.15s;
  }

  .filter-trigger.open svg { transform: rotate(180deg); }

  /* Dropdown panel */
  .filter-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    background: #fff;
    border: 1px solid #DEDEDE;
    border-radius: 2px;
    min-width: 180px;
    z-index: 100;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    padding: 8px 0;
  }

  .filter-dropdown.open { display: block; }

  .filter-option {
    display: flex;
    align-items: center;
    gap: 9px;
    padding: 7px 14px;
    cursor: pointer;
    transition: background 0.12s;
  }

  .filter-option:hover { background: #F0F5F7; }

  .filter-option input[type="checkbox"] {
    width: 13px;
    height: 13px;
    accent-color: #6B8A9A;
    cursor: pointer;
    flex-shrink: 0;
  }

  .filter-option-label {
    font-size: 0.72rem;
    font-weight: 300;
    letter-spacing: 0.04em;
    color: #444;
    text-transform: capitalize;
    cursor: pointer;
    flex: 1;
  }

  /* Clear link inside dropdown */
  .filter-clear {
    display: block;
    padding: 6px 14px;
    font-size: 0.62rem;
    font-weight: 400;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: #aaa;
    cursor: pointer;
    border-top: 1px solid #f5f5f5;
    margin-top: 4px;
    transition: color 0.12s;
  }

  .filter-clear:hover { color: #6B8A9A; }

  /* Count */
  .count-label {
    font-size: 0.65rem;
    font-weight: 300;
    letter-spacing: 0.12em;
    color: #aaa;
    padding-top: 8px;
    flex-shrink: 0;
  }

  /* Grid */
  .scores-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 32px 20px;
  }

  @media (max-width: 680px) {
    .scores-grid { grid-template-columns: repeat(2, 1fr); gap: 24px 14px; }
  }

  /* Card */
  .score-card {
    cursor: pointer;
    display: flex;
    flex-direction: column;
  }

  .score-card.hidden { display: none; }
  .score-card:hover .card-cover { border-color: #6B8A9A; }
  .score-card:hover .card-title { color: #6B8A9A; }

  .card-cover {
    width: 100%;
    border: 1px solid #DEDEDE;
    margin-bottom: 12px;
    transition: border-color 0.18s;
    overflow: hidden;
    background: #F0F5F7;
    position: relative;
  }

  .card-cover img { width: 100%; display: block; }

  .card-cover-placeholder {
    width: 100%;
    aspect-ratio: 1 / 1.2;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    padding: 16px;
  }

  .placeholder-title {
    font-size: clamp(0.7rem, 2.5vw, 0.95rem);
    font-weight: 200;
    letter-spacing: 0.2em;
    color: #bbb;
    text-align: center;
    line-height: 1.4;
  }

  .placeholder-subtitle {
    font-size: 0.58rem;
    font-weight: 300;
    font-style: italic;
    color: #ccc;
    letter-spacing: 0.05em;
    text-align: center;
  }

  .featured-badge {
    position: absolute;
    top: 8px; right: 8px;
    width: 20px; height: 20px;
    background: rgba(255,255,255,0.92);
    border: 1px solid #DEDEDE;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.55rem;
    color: #6B8A9A;
    line-height: 1;
  }

  .coming-soon-badge {
    position: absolute;
    top: 8px; left: 8px;
    background: rgba(255,255,255,0.92);
    border: 1px solid #DEDEDE;
    border-radius: 2px;
    padding: 3px 7px;
    font-size: 0.52rem;
    font-weight: 500;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: #aaa;
  }

  .card-info { flex: 1; display: flex; flex-direction: column; }

  .card-title {
    font-size: 0.88rem;
    font-weight: 400;
    letter-spacing: 0.06em;
    color: #1A1A1A;
    margin-bottom: 2px;
    transition: color 0.18s;
    line-height: 1.3;
  }

  .card-subtitle {
    font-size: 0.72rem;
    font-weight: 300;
    font-style: italic;
    color: #777;
    margin-bottom: 8px;
    line-height: 1.4;
  }

  .card-meta {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 6px;
    margin-top: auto;
  }

  .card-instrumentation {
    font-size: 0.68rem;
    font-weight: 300;
    color: #666;
    letter-spacing: 0.03em;
    line-height: 1.4;
    flex: 1; min-width: 0;
  }

  .card-price {
    font-size: 0.88rem;
    font-weight: 300;
    color: #1A1A1A;
    letter-spacing: 0.03em;
    flex-shrink: 0;
  }

  .card-price.unavailable {
    font-size: 0.6rem;
    font-weight: 400;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: #bbb;
  }

  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    color: #aaa;
    font-size: 0.8rem;
    letter-spacing: 0.08em;
  }

  /* ════════════════════════════════
     DETAIL VIEW
  ════════════════════════════════ */

  /* Back button */
  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    background: none;
    border: none;
    cursor: pointer;
    font-family: 'Jost', sans-serif;
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: #999;
    padding: 0;
    margin-bottom: 28px;
    transition: color 0.15s;
  }

  .back-btn:hover { color: #6B8A9A; }

  .back-btn svg {
    width: 10px; height: 10px;
    fill: currentColor;
  }

  /* Score header */
  .score-header {
    border-bottom: 1px solid #DEDEDE;
    padding-bottom: 24px;
    margin-bottom: 32px;
  }

  .score-title {
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 200;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    line-height: 1.1;
    color: #1A1A1A;
  }

  .score-subtitle {
    font-size: 1rem;
    font-weight: 300;
    font-style: italic;
    color: #777;
    margin-top: 6px;
    letter-spacing: 0.05em;
  }

  /* Two-column layout */
  .score-body {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 52px;
    align-items: start;
  }

  @media (max-width: 680px) {
    .score-body { grid-template-columns: 1fr; gap: 40px; }
    .score-sidebar { order: -1; }
  }

  .section-label {
    font-size: 0.68rem;
    font-weight: 500;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: #6B8A9A;
    margin-bottom: 12px;
  }

  /* Primary media */
  .primary-media { margin-bottom: 24px; }

  .video-wrapper {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
    background: #F0F5F7;
  }

  .video-wrapper iframe {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border: none;
  }

  .sc-wrapper iframe {
    width: 100%;
    height: 166px;
    border: none;
  }

  .audio-wrapper audio { width: 100%; margin-top: 4px; }

  /* Notes + premiere row */
  .notes-premiere-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 20px;
    padding: 20px 0;
    border-top: 1px solid #DEDEDE;
    border-bottom: 1px solid #DEDEDE;
    margin-bottom: 24px;
  }

  .notes-only-row {
    padding: 16px 0;
    border-top: 1px solid #DEDEDE;
    border-bottom: 1px solid #DEDEDE;
    margin-bottom: 24px;
  }

  .notes-trigger {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: none;
    border: 1px solid #6B8A9A;
    border-radius: 3px;
    padding: 7px 14px;
    cursor: pointer;
    font-family: 'Jost', sans-serif;
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    color: #6B8A9A;
    transition: background 0.18s, color 0.18s;
    flex-shrink: 0;
    align-self: flex-end;
  }

  .notes-trigger:hover { background: #6B8A9A; color: #fff; }
  .notes-trigger:hover svg { fill: #fff; }

  .notes-trigger svg {
    width: 12px; height: 12px;
    flex-shrink: 0;
    fill: #6B8A9A;
    transition: fill 0.18s;
  }

  .premiere-inline { text-align: right; flex: 1; min-width: 0; }

  .premiere-label {
    font-size: 0.68rem;
    font-weight: 500;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    color: #777;
    margin-bottom: 5px;
  }

  .premiere-value {
    font-size: 0.84rem;
    font-weight: 300;
    color: #444;
    line-height: 1.6;
  }

  /* Dedication */
  .score-dedication {
    font-size: 0.86rem;
    font-style: italic;
    color: #777;
    margin-bottom: 28px;
    line-height: 1.75;
    padding-left: 14px;
    border-left: 2px solid #DEDEDE;
  }

  /* Score previews */
  .previews-section { margin-bottom: 32px; }

  .preview-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 7px;
  }

  .preview-grid img {
    width: 100%;
    display: block;
    border: 1px solid #DEDEDE;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .preview-grid img:hover { border-color: #6B8A9A; }
  .preview-grid.portrait img { aspect-ratio: 8.5/11; object-fit: cover; }
  .preview-grid.landscape img { aspect-ratio: 11/8.5; object-fit: cover; }
  .preview-grid.large img { aspect-ratio: 1/1.4; object-fit: cover; }

  /* Additional media */
  .additional-media-item { margin-bottom: 16px; }
  .additional-media-item:last-child { margin-bottom: 0; }

  /* Sidebar */
  .score-sidebar { position: sticky; top: 20px; }

  .cover-img {
    width: 100%;
    display: block;
    border: 1px solid #DEDEDE;
  }

  .purchase-block {
    padding-top: 20px;
    border-top: 1px solid #DEDEDE;
    margin-top: 20px;
  }

  .purchase-block.no-cover { margin-top: 0; border-top: none; }

  .purchase-price {
    font-size: 2rem;
    font-weight: 200;
    letter-spacing: 0.04em;
    color: #1A1A1A;
    margin-bottom: 10px;
    text-align: right;
    line-height: 1;
  }

  .file-description {
    font-size: 0.84rem;
    font-weight: 300;
    color: #555;
    line-height: 2;
    margin-bottom: 16px;
    text-align: right;
  }

  .btn-purchase {
    display: block;
    width: 100%;
    padding: 12px 20px;
    background: #1A1A1A;
    color: #fff;
    font-family: 'Jost', sans-serif;
    font-size: 0.72rem;
    font-weight: 500;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    text-align: center;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
    margin-bottom: 12px;
  }

  .btn-purchase:hover { background: #6B8A9A; }

  .btn-purchase.coming-soon {
    background: #DEDEDE;
    color: #aaa;
    cursor: default;
    pointer-events: none;
  }

  .purchase-note {
    font-size: 0.76rem;
    font-weight: 300;
    color: #777;
    text-align: center;
    letter-spacing: 0.06em;
    margin-bottom: 10px;
  }

  .engraving-note {
    font-size: 0.76rem;
    font-weight: 300;
    font-style: italic;
    color: #777;
    text-align: right;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 5px;
  }

  .engraving-note::before {
    content: '✓';
    color: #6B8A9A;
    font-style: normal;
    font-weight: 400;
  }

  /* Spec block */
  .spec-block {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid #DEDEDE;
  }

  .spec-item { margin-bottom: 16px; }
  .spec-item:last-child { margin-bottom: 0; }

  .spec-label {
    font-size: 0.66rem;
    font-weight: 500;
    letter-spacing: 0.24em;
    text-transform: uppercase;
    color: #777;
    margin-bottom: 3px;
    text-align: right;
  }

  .spec-value {
    font-size: 0.88rem;
    font-weight: 300;
    color: #444;
    line-height: 1.5;
    text-align: right;
  }

  .spec-note {
    font-size: 0.78rem;
    font-weight: 300;
    font-style: italic;
    color: #777;
    line-height: 1.5;
    text-align: right;
    margin-top: 2px;
  }

  /* ════════════════════════════════
     MODAL
  ════════════════════════════════ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(26,26,26,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: #fff;
    width: 100%;
    max-width: 860px;
    max-height: 84vh;
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    padding: 22px 32px 18px;
    border-bottom: 1px solid #DEDEDE;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    flex-shrink: 0;
    gap: 20px;
  }

  .modal-title {
    font-size: 0.68rem;
    font-weight: 500;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: #6B8A9A;
  }

  .modal-close {
    background: none;
    border: none;
    cursor: pointer;
    font-family: 'Jost', sans-serif;
    font-size: 0.62rem;
    font-weight: 400;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: #aaa;
    padding: 0;
    transition: color 0.15s;
  }

  .modal-close:hover { color: #1A1A1A; }

  .modal-body {
    overflow-y: auto;
    padding: 32px 32px 40px;
    flex: 1;
  }

  .modal-body::-webkit-scrollbar { width: 4px; }
  .modal-body::-webkit-scrollbar-track { background: #f5f5f5; }
  .modal-body::-webkit-scrollbar-thumb { background: #DEDEDE; }
  .modal-body::-webkit-scrollbar-thumb:hover { background: #6B8A9A; }

  .program-notes {
    font-size: 0.9rem;
    font-weight: 300;
    line-height: 1.9;
    color: #444;
    max-width: 680px;
    margin: 0 auto;
  }

  .program-notes p { margin-bottom: 1.3em; }
  .program-notes p:last-child { margin-bottom: 0; }
  .program-notes em { font-style: italic; }
  .program-notes strong { font-weight: 500; color: #1A1A1A; }
  .program-notes strong em, .program-notes em strong {
    font-style: italic; font-weight: 500; color: #1A1A1A;
  }
</style>
</head>
<body>

<div id="loading">Loading</div>
<div id="error-msg" style="display:none"></div>

<!-- ── CATALOG VIEW ── -->
<div id="catalog-view" style="display:none">
  <div class="store-header">
    <div class="store-title">Sheet Music</div>
    <div class="store-description">
      Sheet music is available via digital download only. To order physical copies of any score, please <a href="mailto:tylerklinemusic@gmail.com">contact the composer</a>.
    </div>
  </div>

  <div class="toolbar">
    <div class="filters-wrap">

      <!-- Ensemble Type filter -->
      <div class="filter-group" id="fg-ensemble">
        <div class="filter-group-label">Ensemble Type</div>
        <button class="filter-trigger" id="ft-ensemble" onclick="toggleDropdown('ensemble')">
          <span id="ft-ensemble-label">All</span>
          <svg viewBox="0 0 10 6"><path d="M0 0l5 6 5-6z"/></svg>
        </button>
        <div class="filter-dropdown" id="fd-ensemble"></div>
      </div>

      <!-- Instrument filter -->
      <div class="filter-group" id="fg-instrument">
        <div class="filter-group-label">Instrument</div>
        <button class="filter-trigger" id="ft-instrument" onclick="toggleDropdown('instrument')">
          <span id="ft-instrument-label">All</span>
          <svg viewBox="0 0 10 6"><path d="M0 0l5 6 5-6z"/></svg>
        </button>
        <div class="filter-dropdown" id="fd-instrument"></div>
      </div>

    </div>
    <div class="count-label" id="count-label">— scores</div>
  </div>

  <div class="scores-grid" id="scores-grid"></div>
</div>

<!-- ── DETAIL VIEW ── -->
<div id="detail-view" style="display:none">
  <button class="back-btn" onclick="showCatalog()">
    <svg viewBox="0 0 10 10"><path d="M7 1L3 5l4 4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
    All Scores
  </button>
  <div id="detail-content"></div>
</div>

<!-- ── PROGRAM NOTES MODAL ── -->
<div class="modal-overlay" id="notesModal" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modal-title">Program Notes</span>
      <button class="modal-close" onclick="closeModal()">Close</button>
    </div>
    <div class="modal-body">
      <div class="program-notes" id="modal-notes"></div>
    </div>
  </div>
</div>

<script>
const SHEET_ID = '1BKBjoczBkt8uX2Xc___e_ZFErJyj1fyj_X7VioIz3aY';
const SHEET_NAME = 'Sheet1';

let allScores = [];
let selectedEnsemble = new Set();
let selectedInstruments = new Set();

// ── DATA ──────────────────────────────────────

async function fetchData() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\)/)[1]);
  const cols = json.table.cols.map(c => c.label);
  return json.table.rows.map(row => {
    const obj = {};
    cols.forEach((col, i) => {
      const cell = row.c[i];
      if (!cell || cell.v === null || cell.v === undefined) {
        obj[col] = '';
      } else if (typeof cell.v === 'boolean') {
        obj[col] = cell.v ? 'TRUE' : 'FALSE';
      } else {
        obj[col] = String(cell.v).trim();
      }
    });
    return obj;
  }).filter(r => r.Title && r.ShowInStore === 'TRUE');
}

// ── HELPERS ──────────────────────────────────

function parseList(val) {
  if (!val) return [];
  return val.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
}

function cleanText(s) {
  return s ? s.replace(/[\u200B\u200C\u200D\uFEFF]/g, '').trim() : '';
}

function parseMarkdown(text) {
  if (!text) return '';
  text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  text = text.replace(/\*\*\*(.+?)\*\*\*/gs, '<strong><em>$1</em></strong>');
  text = text.replace(/\*\*(.+?)\*\*/gs, '<strong>$1</strong>');
  text = text.replace(/\*(.+?)\*/gs, '<em>$1</em>');
  return text;
}

function textToHTML(text) {
  if (!text) return '';
  const paras = text.split(/\n\s*\n/).map(p => p.trim()).filter(Boolean);
  return paras.map(p => {
    const lines = p.split(/\n/).map(l => parseMarkdown(l.trim())).join('<br>');
    return `<p>${lines}</p>`;
  }).join('');
}

function parsePremiereInfo(val) {
  if (!val) return null;
  if (val.includes('|')) return val.split('|').map(s => s.trim()).filter(Boolean);
  return [val];
}

function parsePrice(val) {
  if (!val) return null;
  const n = parseFloat(String(val).replace(/[^0-9.]/g, ''));
  return isNaN(n) ? null : n;
}

function formatPrice(n) {
  return '$' + (Number.isInteger(n) ? n : n.toFixed(2));
}

function toYouTubeEmbed(url) {
  if (!url) return null;
  url = url.trim();
  if (url.includes('youtube.com/embed/')) return url;
  let m = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
  if (m) return `https://www.youtube.com/embed/${m[1]}`;
  m = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
  if (m) return `https://www.youtube.com/embed/${m[1]}`;
  return null;
}

function toSoundCloudEmbed(url) {
  if (!url) return null;
  if (url.includes('soundcloud.com'))
    return `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%236B8A9A&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false`;
  return null;
}

function mediaEmbed(url) {
  if (!url) return null;
  url = url.trim();
  const yt = toYouTubeEmbed(url);
  if (yt) return `<div class="video-wrapper"><iframe src="${yt}" allowfullscreen loading="lazy"></iframe></div>`;
  const sc = toSoundCloudEmbed(url);
  if (sc) return `<div class="sc-wrapper"><iframe src="${sc}" scrolling="no" allow="autoplay"></iframe></div>`;
  if (url.match(/\.(mp3|wav|ogg|aac|m4a)(\?|$)/i))
    return `<div class="audio-wrapper"><audio controls src="${url}"></audio></div>`;
  return null;
}

function previewClass(format) {
  if (!format) return 'portrait';
  const f = format.toLowerCase();
  if (f === 'landscape') return 'landscape';
  if (f === 'large') return 'large';
  return 'portrait';
}

// ── FILTER DROPDOWNS ─────────────────────────

function buildFilterOptions() {
  const ensembleSet = new Set();
  const instrumentSet = new Set();

  allScores.forEach(s => {
    parseList(s.EnsembleType).forEach(v => ensembleSet.add(v));
    parseList(s.Instruments).forEach(v => instrumentSet.add(v));
  });

  buildDropdown('ensemble', [...ensembleSet].sort(), selectedEnsemble);
  buildDropdown('instrument', [...instrumentSet].sort(), selectedInstruments);
}

function buildDropdown(type, options, selectedSet) {
  const el = document.getElementById(`fd-${type}`);
  el.innerHTML = options.map(opt => `
    <label class="filter-option">
      <input type="checkbox" value="${opt}" onchange="onFilterChange('${type}', '${opt}', this.checked)">
      <span class="filter-option-label">${opt}</span>
    </label>
  `).join('') + `<span class="filter-clear" onclick="clearFilter('${type}')">Clear</span>`;
}

function toggleDropdown(type) {
  const trigger = document.getElementById(`ft-${type}`);
  const dropdown = document.getElementById(`fd-${type}`);
  const isOpen = dropdown.classList.contains('open');

  // Close all
  document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('open'));
  document.querySelectorAll('.filter-trigger').forEach(t => t.classList.remove('open'));

  if (!isOpen) {
    dropdown.classList.add('open');
    trigger.classList.add('open');
  }
}

function onFilterChange(type, value, checked) {
  const set = type === 'ensemble' ? selectedEnsemble : selectedInstruments;
  checked ? set.add(value) : set.delete(value);
  updateTriggerLabel(type);
  applyFilters();
}

function clearFilter(type) {
  const set = type === 'ensemble' ? selectedEnsemble : selectedInstruments;
  set.clear();
  document.querySelectorAll(`#fd-${type} input`).forEach(cb => cb.checked = false);
  updateTriggerLabel(type);
  applyFilters();
}

function updateTriggerLabel(type) {
  const set = type === 'ensemble' ? selectedEnsemble : selectedInstruments;
  const label = document.getElementById(`ft-${type}-label`);
  const trigger = document.getElementById(`ft-${type}`);
  if (set.size === 0) {
    label.textContent = 'All';
    trigger.classList.remove('has-selection');
  } else if (set.size === 1) {
    label.textContent = [...set][0];
    trigger.classList.add('has-selection');
  } else {
    label.textContent = `${set.size} selected`;
    trigger.classList.add('has-selection');
  }
}

function applyFilters() {
  const cards = document.querySelectorAll('.score-card');
  let visible = 0;
  cards.forEach(card => {
    const ensembleTags = parseList(card.dataset.ensemble);
    const instrumentTags = parseList(card.dataset.instruments);

    const ensembleMatch = selectedEnsemble.size === 0 ||
      [...selectedEnsemble].some(v => ensembleTags.includes(v));
    const instrumentMatch = selectedInstruments.size === 0 ||
      [...selectedInstruments].some(v => instrumentTags.includes(v));

    const show = ensembleMatch && instrumentMatch;
    card.classList.toggle('hidden', !show);
    if (show) visible++;
  });

  document.getElementById('count-label').textContent =
    visible === 1 ? '1 score' : `${visible} scores`;

  // Empty state
  let empty = document.getElementById('empty-state');
  if (visible === 0) {
    if (!empty) {
      empty = document.createElement('div');
      empty.id = 'empty-state';
      empty.className = 'empty-state';
      empty.textContent = 'No scores match the selected filters.';
      document.getElementById('scores-grid').appendChild(empty);
    }
  } else if (empty) {
    empty.remove();
  }
}

// Close dropdowns when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.filter-group')) {
    document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('open'));
    document.querySelectorAll('.filter-trigger').forEach(t => t.classList.remove('open'));
  }
});

// ── CATALOG RENDER ───────────────────────────

function renderCatalog() {
  // Sort: featured first, then by DateAdded desc, then sheet order
  const sorted = [...allScores].sort((a, b) => {
    const aF = a.Featured === 'TRUE' ? 0 : 1;
    const bF = b.Featured === 'TRUE' ? 0 : 1;
    if (aF !== bF) return aF - bF;
    const aD = a.DateAdded ? new Date(a.DateAdded) : new Date(0);
    const bD = b.DateAdded ? new Date(b.DateAdded) : new Date(0);
    return bD - aD;
  });

  const grid = document.getElementById('scores-grid');
  grid.innerHTML = '';

  sorted.forEach(score => {
    const price = parsePrice(score.Price);
    const hasProduct = score.WixProductID && score.WixProductID.length > 5;
    const isFeatured = score.Featured === 'TRUE';
    const isComingSoon = !hasProduct;

    const card = document.createElement('div');
    card.className = 'score-card';
    card.dataset.ensemble = (score.EnsembleType || '').toLowerCase();
    card.dataset.instruments = (score.Instruments || '').toLowerCase();
    card.onclick = () => showDetail(score.Title);

    // Cover
    let coverHTML = '';
    if (score.CoverImage) {
      coverHTML = `<img src="${score.CoverImage}" alt="${score.Title} cover">`;
    } else {
      coverHTML = `<div class="card-cover-placeholder">
        <div class="placeholder-title">${score.Title}</div>
        ${score.Subtitle ? `<div class="placeholder-subtitle">${score.Subtitle}</div>` : ''}
      </div>`;
    }

    card.innerHTML = `
      <div class="card-cover">
        ${coverHTML}
        ${isFeatured ? '<div class="featured-badge">★</div>' : ''}
        ${isComingSoon ? '<div class="coming-soon-badge">Coming Soon</div>' : ''}
      </div>
      <div class="card-info">
        <div class="card-title">${score.Title}</div>
        ${score.Subtitle ? `<div class="card-subtitle">${score.Subtitle}</div>` : ''}
        <div class="card-meta">
          <div class="card-instrumentation">${score.Instrumentation || ''}</div>
          ${price !== null
            ? `<div class="card-price">${formatPrice(price)}</div>`
            : `<div class="card-price unavailable">Coming Soon</div>`}
        </div>
      </div>`;

    grid.appendChild(card);
  });

  document.getElementById('count-label').textContent =
    allScores.length === 1 ? '1 score' : `${allScores.length} scores`;
}

// ── DETAIL RENDER ────────────────────────────

function renderDetail(score) {
  const price = parsePrice(score.Price);
  const premiere = parsePremiereInfo(cleanText(score.PremiereInfo));
  const dedication = cleanText(score.CommissionAndDedicationNote);
  const previews = (score.PreviewImages || '').split(',').map(s => s.trim()).filter(Boolean);
  const additionalMedia = (score.AdditionalMedia || '').split(',').map(s => s.trim()).filter(Boolean);
  const primaryMediaURL = (score.PrimaryMedia || '').trim();
  const fileItems = score.FileDescription
    ? score.FileDescription.split('·').map(s => s.trim()).filter(Boolean)
    : [];
  const hasProduct = score.WixProductID && score.WixProductID.length > 5;
  const hasProgramNotes = cleanText(score.ProgramNotes).length > 0;
  const format = (score.ScoreFormat || '').trim();

  let html = `
    <div class="score-header">
      <div class="score-title">${score.Title}</div>
      ${score.Subtitle ? `<div class="score-subtitle">${score.Subtitle}</div>` : ''}
    </div>
    <div class="score-body">
    <div class="score-main">`;

  // Primary media
  if (primaryMediaURL) {
    const embed = mediaEmbed(primaryMediaURL);
    if (embed) html += `<div class="primary-media"><div class="section-label">Listen</div>${embed}</div>`;
  }

  // Notes + premiere row
  if (hasProgramNotes || premiere) {
    if (hasProgramNotes && premiere) {
      html += `<div class="notes-premiere-row">
        <button class="notes-trigger" onclick="openModal()">
          <svg viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="2" width="10" height="1.2" rx="0.6"/>
            <rect x="1" y="5.4" width="7" height="1.2" rx="0.6"/>
            <rect x="1" y="8.8" width="8.5" height="1.2" rx="0.6"/>
          </svg>Program Notes
        </button>
        <div class="premiere-inline">
          <div class="premiere-label">Premiere</div>
          <div class="premiere-value">${premiere.join('<br>')}</div>
        </div>
      </div>`;
    } else if (hasProgramNotes) {
      html += `<div class="notes-only-row">
        <button class="notes-trigger" onclick="openModal()">
          <svg viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="2" width="10" height="1.2" rx="0.6"/>
            <rect x="1" y="5.4" width="7" height="1.2" rx="0.6"/>
            <rect x="1" y="8.8" width="8.5" height="1.2" rx="0.6"/>
          </svg>Program Notes
        </button>
      </div>`;
    } else {
      html += `<div class="notes-premiere-row" style="justify-content:flex-end;">
        <div class="premiere-inline">
          <div class="premiere-label">Premiere</div>
          <div class="premiere-value">${premiere.join('<br>')}</div>
        </div>
      </div>`;
    }
  }

  if (dedication) html += `<div class="score-dedication">${parseMarkdown(dedication)}</div>`;

  if (previews.length) {
    html += `<div class="previews-section">
      <div class="section-label">Score Preview</div>
      <div class="preview-grid ${previewClass(format)}">
        ${previews.map(src => `<img src="${src}" alt="Score preview" loading="lazy">`).join('')}
      </div>
    </div>`;
  }

  if (additionalMedia.length) {
    html += `<div class="additional-media-section"><div class="section-label">Additional Media</div>`;
    additionalMedia.forEach(url => {
      const embed = mediaEmbed(url);
      if (embed) html += `<div class="additional-media-item">${embed}</div>`;
    });
    html += `</div>`;
  }

  html += `</div>`; // end score-main

  // Sidebar
  html += `<div class="score-sidebar">`;

  if (score.CoverImage) {
    html += `<img class="cover-img" src="${score.CoverImage}" alt="${score.Title} cover">`;
  }

  html += `<div class="purchase-block${!score.CoverImage ? ' no-cover' : ''}">`;
  if (price !== null) html += `<div class="purchase-price">${formatPrice(price)}</div>`;
  if (fileItems.length) {
    html += `<div class="file-description">${fileItems.map(i => `<div>${i}</div>`).join('')}</div>`;
  }
  if (hasProduct) {
    html += `<button class="btn-purchase" onclick="handlePurchase('${score.WixProductID}')">Add to Cart</button>`;
  } else {
    html += `<button class="btn-purchase coming-soon">Coming Soon</button>`;
  }
  html += `<div class="purchase-note">Secure checkout via Wix</div>
    <div class="engraving-note">All sheet music professionally engraved and typeset</div>
  </div>`;

  const specs = [
    score.Year && { label: 'Year', value: score.Year },
    score.Instrumentation && { label: 'Instrumentation', value: score.Instrumentation },
    score.Duration && { label: 'Duration', value: score.Duration },
    score.Pages && { label: 'Pages', value: score.Pages },
    score.Difficulty && { label: 'Difficulty', value: score.Difficulty, note: score.DifficultyNote || '' },
  ].filter(Boolean);

  if (specs.length) {
    html += `<div class="spec-block">`;
    specs.forEach(s => {
      html += `<div class="spec-item">
        <div class="spec-label">${s.label}</div>
        <div class="spec-value">${s.value}</div>
        ${s.note ? `<div class="spec-note">${s.note}</div>` : ''}
      </div>`;
    });
    html += `</div>`;
  }

  html += `</div></div>`; // end sidebar + score-body

  document.getElementById('detail-content').innerHTML = html;
  document.getElementById('modal-title').textContent = `Program Notes — ${score.Title}`;
  document.getElementById('modal-notes').innerHTML = hasProgramNotes
    ? textToHTML(cleanText(score.ProgramNotes)) : '';
}

// ── NAVIGATION ───────────────────────────────

function showCatalog() {
  document.getElementById('detail-view').style.display = 'none';
  document.getElementById('catalog-view').style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showDetail(title) {
  const score = allScores.find(s => s.Title === title);
  if (!score) return;
  renderDetail(score);
  document.getElementById('catalog-view').style.display = 'none';
  document.getElementById('detail-view').style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ── MODAL ────────────────────────────────────

function openModal() {
  document.getElementById('notesModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('notesModal').classList.remove('open');
  document.body.style.overflow = '';
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('notesModal')) closeModal();
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

function handlePurchase(productId) {
  window.parent.postMessage({ type: 'addToCart', productId }, '*');
}

// ── INIT ─────────────────────────────────────

async function init() {
  try {
    allScores = await fetchData();
    if (!allScores.length) throw new Error('No store products found.');
    buildFilterOptions();
    renderCatalog();
    document.getElementById('loading').style.display = 'none';
    document.getElementById('catalog-view').style.display = 'block';
  } catch(e) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error-msg').style.display = 'block';
    document.getElementById('error-msg').textContent = 'Unable to load scores. ' + e.message;
    console.error(e);
  }
}

init();
</script>
</body>
</html>
