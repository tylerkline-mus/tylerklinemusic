<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sheet Diagnostic</title>
<style>
  body { font-family: monospace; padding: 20px; font-size: 13px; }
  pre { background: #f5f5f5; padding: 16px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
  h2 { font-family: sans-serif; margin-top: 24px; }
  .ok { color: green; }
  .fail { color: red; }
</style>
</head>
<body>
<h2>Sheet Fetch Diagnostic</h2>
<div id="out">Fetching...</div>

<script>
const SHEET_ID = '1BKBjoczBkt8uX2Xc___e_ZFErJyj1fyj_X7VioIz3aY';
const SHEET_NAME = 'Sheet1';

async function run() {
  const out = document.getElementById('out');
  try {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
    out.innerHTML += `<p>Fetching: <code>${url}</code></p>`;

    const res = await fetch(url);
    out.innerHTML += `<p>HTTP status: <strong>${res.status}</strong></p>`;

    const text = await res.text();
    out.innerHTML += `<p>Raw response (first 500 chars):</p><pre>${text.substring(0, 500)}</pre>`;

    const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\)/);
    if (!match) {
      out.innerHTML += `<p class="fail">Could not parse gviz response — sheet may not be public or tab name is wrong.</p>`;
      return;
    }

    const json = JSON.parse(match[1]);
    const cols = json.table.cols.map(c => c.label);
    out.innerHTML += `<h2>Columns found (${cols.length}):</h2><pre>${JSON.stringify(cols, null, 2)}</pre>`;

    const rows = json.table.rows.map(row => {
      const obj = {};
      cols.forEach((col, i) => {
        const cell = row.c[i];
        obj[col] = (cell && cell.v !== null && cell.v !== undefined) ? String(cell.v) : '';
      });
      return obj;
    });

    out.innerHTML += `<h2>Total rows: ${rows.length}</h2>`;

    // Show ShowInStore values
    out.innerHTML += `<h2>ShowInStore values per row:</h2><pre>`;
    rows.forEach((r, i) => {
      const val = r['ShowInStore'];
      const raw = JSON.stringify(json.table.rows[i]?.c[cols.indexOf('ShowInStore')]);
      out.innerHTML += `Row ${i+1} — Title: "${r.Title}" | ShowInStore: "${val}" | raw cell: ${raw}\n`;
    });
    out.innerHTML += `</pre>`;

    const storeRows = rows.filter(r => r.ShowInStore === 'TRUE');
    out.innerHTML += `<p class="${storeRows.length ? 'ok' : 'fail'}">Rows passing ShowInStore === 'TRUE' filter: <strong>${storeRows.length}</strong></p>`;

    if (storeRows.length) {
      out.innerHTML += `<h2>First matching row:</h2><pre>${JSON.stringify(storeRows[0], null, 2)}</pre>`;
    }

  } catch(e) {
    out.innerHTML += `<p class="fail">Error: ${e.message}</p>`;
    console.error(e);
  }
}

run();
</script>
</body>
</html>
